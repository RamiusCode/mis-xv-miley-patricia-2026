---
// MusicPlayer.astro - Card compacto elegante rosa
---

<div class="w-full max-w-xs mx-auto px-4" id="player-wrapper">
  <div
    id="player-card"
    class="w-full bg-white/15 backdrop-blur-xl border border-[#eb8fa3]/30 rounded-2xl px-5 py-4 shadow-[0_8px_32px_rgba(235,143,163,0.15)]"
  >
    <!-- Título -->
    <div class="text-center mb-3" id="player-title">
      <h3 class="font-great-vibes text-2xl text-[#eb8fa3] tracking-wide">
        Mi Canción Especial
      </h3>
      <div class="flex items-center justify-center gap-2 mt-0.5">
        <div
          class="h-px w-10 bg-gradient-to-r from-transparent to-[#eb8fa3]/50"
        >
        </div>
        <span class="text-[#eb8fa3]/60 text-[10px]">✦</span>
        <div
          class="h-px w-10 bg-gradient-to-l from-transparent to-[#eb8fa3]/50"
        >
        </div>
      </div>
    </div>

    <!-- Controles -->
    <div
      id="controls-container"
      class="flex items-center justify-center gap-7 mb-3"
    >
      <button
        id="prevBtn"
        class="text-[#eb8fa3]/50 hover:text-[#eb8fa3] transition-all duration-200 hover:scale-110 focus:outline-none"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path>
        </svg>
      </button>

      <button
        id="playPauseBtn"
        class="w-[46px] h-[46px] rounded-full bg-gradient-to-br from-[#eb8fa3] to-[#c96e85] shadow-[0_4px_15px_rgba(235,143,163,0.4)] flex items-center justify-center hover:scale-110 hover:shadow-[0_6px_20px_rgba(235,143,163,0.5)] transition-all duration-200 focus:outline-none"
      >
        <svg
          id="play-icon"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="white"
        >
          <path d="M8 5v14l11-7z"></path>
        </svg>
        <svg
          id="pause-icon"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="white"
          class="hidden"
        >
          <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path>
        </svg>
      </button>

      <button
        id="nextBtn"
        class="text-[#eb8fa3]/50 hover:text-[#eb8fa3] transition-all duration-200 hover:scale-110 focus:outline-none"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 18l8.5-6L6 6v12zm10-12h2v12h-2z"></path>
        </svg>
      </button>
    </div>

    <!-- Barra de progreso -->
    <div id="progress-container">
      <div
        class="flex justify-between text-[9px] text-[#eb8fa3]/50 mb-1 font-medium tracking-wide"
      >
        <span id="currentTime">0:00</span>
        <span id="totalDuration">--:--</span>
      </div>
      <div
        class="relative w-full h-1 bg-[#eb8fa3]/15 rounded-full overflow-hidden"
      >
        <div
          id="progress-fill"
          class="h-full bg-gradient-to-r from-[#eb8fa3] to-[#f5afc0] rounded-full transition-all duration-100"
          style="width: 0%"
        >
        </div>
        <input
          type="range"
          id="progressBar"
          value="0"
          max="100"
          class="absolute inset-0 w-full opacity-0 cursor-pointer h-full"
        />
      </div>
    </div>
  </div>
</div>

<audio id="music-audio" preload="auto">
  <source src="/audio/retro.mp3" type="audio/mpeg" />
</audio>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  let isPlaying = false;

  document.addEventListener("DOMContentLoaded", () => {
    // Estado inicial — todo invisible
    gsap.set("#player-wrapper", { opacity: 0, y: 30, scale: 0.94 });
    gsap.set("#player-title", { opacity: 0, y: -15 });
    gsap.set("#controls-container", { opacity: 0, scale: 0.85 });
    gsap.set("#progress-container", { opacity: 0, y: 10 });

    ScrollTrigger.create({
      trigger: "#player-wrapper",
      start: "top 95%",

      onEnter: () => {
        const tl = gsap.timeline();

        // Todos al mismo tiempo con el 0
        tl.to(
          "#player-wrapper",
          {
            opacity: 1,
            y: 0,
            scale: 1,
            duration: 0.9,
            ease: "back.out(1.3)",
          },
          0,
        )
          .to(
            "#player-title",
            {
              opacity: 1,
              y: 0,
              duration: 0.8,
              ease: "power3.out",
            },
            0,
          )
          .to(
            "#controls-container",
            {
              opacity: 1,
              scale: 1,
              duration: 0.8,
              ease: "back.out(1.5)",
            },
            0,
          )
          .to(
            "#progress-container",
            {
              opacity: 1,
              y: 0,
              duration: 0.7,
              ease: "power3.out",
            },
            0,
          );
      },

      onLeaveBack: () => {
        gsap.to(
          [
            "#player-wrapper",
            "#player-title",
            "#controls-container",
            "#progress-container",
          ],
          {
            opacity: 0,
            duration: 0.4,
            ease: "power2.in",
          },
        );
        gsap.to("#player-wrapper", { y: 30, scale: 0.94, duration: 0.4 });
      },
    });

    const audio = document.getElementById("music-audio");
    if (audio instanceof HTMLAudioElement) {
      audio.addEventListener("loadedmetadata", () => updateTotal(audio));
      audio.addEventListener("timeupdate", () => updateProgress(audio));
    }

    document
      .getElementById("playPauseBtn")
      ?.addEventListener("click", togglePlay);
    document.getElementById("prevBtn")?.addEventListener("click", () =>
      gsap.to("#prevBtn", {
        scale: 1.3,
        duration: 0.1,
        yoyo: true,
        repeat: 1,
      }),
    );
    document.getElementById("nextBtn")?.addEventListener("click", () =>
      gsap.to("#nextBtn", {
        scale: 1.3,
        duration: 0.1,
        yoyo: true,
        repeat: 1,
      }),
    );
    document
      .getElementById("progressBar")
      ?.addEventListener("input", seekAudio);
  });

  function togglePlay() {
    const audio = document.getElementById("music-audio");
    const playIcon = document.getElementById("play-icon");
    const pauseIcon = document.getElementById("pause-icon");
    const btn = document.getElementById("playPauseBtn");
    if (!(audio instanceof HTMLAudioElement)) return;
    if (!isPlaying) {
      audio.play().catch(console.error);
      playIcon?.classList.add("hidden");
      pauseIcon?.classList.remove("hidden");
      gsap.to(btn, { scale: 1.15, duration: 0.15, yoyo: true, repeat: 1 });
      isPlaying = true;
    } else {
      audio.pause();
      playIcon?.classList.remove("hidden");
      pauseIcon?.classList.add("hidden");
      isPlaying = false;
    }
  }

  function updateProgress(audio: HTMLAudioElement) {
    const fill = document.getElementById("progress-fill");
    const bar = document.getElementById("progressBar");
    const current = document.getElementById("currentTime");
    const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
    if (fill instanceof HTMLElement) fill.style.width = pct + "%";
    if (bar instanceof HTMLInputElement) bar.value = pct.toString();
    if (current) {
      const m = Math.floor(audio.currentTime / 60);
      const s = Math.floor(audio.currentTime % 60)
        .toString()
        .padStart(2, "0");
      current.textContent = `${m}:${s}`;
    }
  }

  function updateTotal(audio: HTMLAudioElement) {
    const total = document.getElementById("totalDuration");
    if (!total || !audio.duration) return;
    const m = Math.floor(audio.duration / 60);
    const s = Math.floor(audio.duration % 60)
      .toString()
      .padStart(2, "0");
    total.textContent = `${m}:${s}`;
  }

  function seekAudio() {
    const bar = document.getElementById("progressBar");
    const audio = document.getElementById("music-audio");
    if (
      !(bar instanceof HTMLInputElement) ||
      !(audio instanceof HTMLAudioElement)
    )
      return;
    audio.currentTime = (Number(bar.value) / 100) * audio.duration;
  }
</script>
